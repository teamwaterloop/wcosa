#!/bin/bash -e
#!/usr/bin/env bash

CUR_DIR=$(cd -P -- "$(dirname -- "$0")" && pwd -P)

OS_TYPE=undefined
GCC_AVR_STATUS=undefined

export COSA_DIR=$CUR_DIR/platform/cosa
export GCC_AVR_VER=gcc-avr-4.2

BOARDS_TXT_LOC=$COSA_DIR/build/boards.txt
WMAKE_LOCK=$CUR_DIR/wmake.lock

set -o nounset
set -o errexit

trap 'echo "Aborting due to errexit on line $LINENO. Exit code: $?" >&2' ERR



set -o errtrace
set -o pipefail

DEFAULT_IFS="${IFS}"
SAFER_IFS=$'\n\t'
IFS="${SAFER_IFS}"

_ME=$(basename "${0}")

_print_help() {
  cat <<HEREDOC
                 __               .__
__  _  _______ _/  |_  ___________|  |   ____   ____ ______
\ \/ \/ /\__  \\   __\/ __ \_  __  \\  |  /  _ \ /  _ \\\____ \\
 \     /  / __ \|  | \  ___/|  | \/  |_(  <_> |  <_> )  |_> >
  \/\_/  (____  /__|  \___  >__|  |____/\____/ \____/|   __/
              \/          \/                         |__|
The Embedded C++ code base builder
Usage:
  ${_ME} [help] [boards]
Options:
  help               Show this screen.
  boards             Show available boards.
  build              Build the project
HEREDOC
}

# Function runs to ensure the environment is correctly
# setup for Cosa builds.
# 1. Checks that `boards.txt` exists and is not empty
# 2. Verifies installation of `gcc-avr`
_pre() {
  # Create wmake.lock
  if [ ! -f $WMAKE_LOCK ] ; then
    touch $WMAKE_LOCK
  fi

  # Read lock file and store variables
  while IFS= read -r line
  do
    while IFS='=' read -ra ADDR; do
      if [ ${ADDR[0]} == "ostype" ] ; then
        OS_TYPE=${ADDR[1]}
      elif [ ${ADDR[0]} == "gccavrstatus" ] ; then
        GCC_AVR_STATUS=${ADDR[1]}
      fi
    done <<< "$line"
  done < "$WMAKE_LOCK"

  # Check OS identification
  if [ $OS_TYPE == "undefined" ] ; then
    echo "Identifying OS Type"
    if [[ "$OSTYPE" == "linux-gnu" ]] ; then
      OS_TYPE="linux"
    elif [[ "$OSTYPE" == "darwin"* ]] ; then
      OS_TYPE="macos"
    else
      echo "Supported OS: Linux, MacOS"
      exit 1
    fi
    if [ ! $OS_TYPE == "undefined" ] ; then
      echo "ostype=$OS_TYPE" >> $WMAKE_LOCK
    fi
  fi

  # Check dependency status
  if [ $GCC_AVR_STATUS == "undefined" ] ; then
    echo "Checking for dependencies"
    if [[ $OS_TYPE == 'linux' ]] ; then
      echo "Checking apt-get for gcc-avr, avr-libc, avrdude"
      sudo apt-get install gcc-avr avr-libc avrdude
    elif [[ $OS_TYPE == 'macos' ]] ; then
      xcode-select --install || :
      echo "Checking HomeBrew for avr-gcc"
      brew tap osx-cross/avr
      brew install avr-gcc
    fi
    GCC_AVR_STATUS=
    echo "Dependencies all set!"
    echo "gccavrstatus=$GCC_AVR_STATUS" >> $WMAKE_LOCK
  fi

  # Create boards.txt
  if [ ! -f $BOARDS_TXT_LOC ] ; then
    touch $BOARDS_TXT_LOC
  fi
  if [ ! -s $BOARDS_TXT_LOC ] ; then
    echo "Generating standard boards.txt"
    cat $COSA_DIR/boards.txt > $BOARDS_TXT_LOC
  fi
}

_simple() {
    root_dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
    root_dir_name=$(basename "$root_dir")
    cd "$root_dir"

    if [ "$1" == 'boards' ] ; then
      (cd $COSA_DIR/build && ./cosa boards)
    #elif [ "$1" == 'build' ] ; then

    else
      _print_help
    fi
}

_main() {
    if [[ "${1:-}" =~ ^h|help$  ]] || [ $# -lt "1" ] ; then
      _print_help
    else
      _simple "$@"
    fi
}

_pre
_main "$@"
